if (self.CavalryLogger) { CavalryLogger.start_js(["iBG55"]); }

__d("FBRTCIncomingCallController",["fbt","Cache","DocumentTitle","FBRTCCallBlockingStore","FBRTCCallSummary","FBRTCCallSummaryStore","FBRTCCallUIWrapper","FBRTCConstants","FBRTCLocalMessageQueue","FBRTCLocalUploadLogLevel","FBRTCLogger","FBRTCMessage","FBRTCMessageDedup","FBRTCMessageSender","FBRTCSupport","MercuryIDs","MessengerParticipants.bs","RTCSignalingExperiments","RTWebExperiments","UserActivity"],(function(a,b,c,d,e,f,g){__p&&__p();var h=30;a=function(){"use strict";__p&&__p();function a(a,c,d){this.$11=null,this.$1=a,this.$2=c,this.$3=d,this.$4=null,this.$5=null,this.$6=new(b("FBRTCMessageSender"))(),this.$7=b("FBRTCCallSummaryStore").getInstance(),this.$8=b("FBRTCLogger").getInstance(),this.$9=null,this.$10=new(b("Cache"))()}var c=a.prototype;c.setCustomAnswerHandler=function(a){this.$11=a};c.onMessageReceived=function(a){__p&&__p();var c;try{c=new(b("FBRTCMessage"))(a)}catch(b){this.$8.logErrorWithoutID("Unknown data: "+JSON.stringify(a));return}if(!b("FBRTCMessageDedup").check(c.peerID,c.callID,c.msgID)){c.isOffer()&&this.$12()&&this.$6.sendOfferAck(c.peerID,c.callID,c.msg);this.$8.logInfo(c.peerID,c.callID,"Ignoring message (duplicate): "+c.msgID);return}this.$8.logReceivedMessage(c.peerID,c.callID,c.msg);!b("RTWebExperiments").enableCallCollisionFix()&&b("FBRTCSupport").isWebrtcSupported()&&c.msgType!==b("FBRTCConstants").PayloadType.OFFER&&b("FBRTCLocalMessageQueue").enqueueMessage(c.peerID,c.msgID,a);switch(c.msgType){case b("FBRTCConstants").PayloadType.OFFER:this.$13(c);break;case b("FBRTCConstants").PayloadType.HANGUP:this.$14(c);break;case b("FBRTCConstants").PayloadType.OTHER_DISMISS:this.$15(c);break;case b("FBRTCConstants").PayloadType.ICE_CANDIDATE:case b("FBRTCConstants").PayloadType.OFFER_ACK:case b("FBRTCConstants").PayloadType.ANSWER:case b("FBRTCConstants").PayloadType.MSG_ACK:case b("FBRTCConstants").PayloadType.OK:case b("FBRTCConstants").PayloadType.PING:case b("FBRTCConstants").PayloadType.PRANSWER:case b("FBRTCConstants").PayloadType.ICERESTART_OFFER:case b("FBRTCConstants").PayloadType.ICERESTART_ANSWER:case b("FBRTCConstants").PayloadType.PCRESTART_ANSWER:case b("FBRTCConstants").PayloadType.PCRESTART_OFFER:case b("FBRTCConstants").PayloadType.SDP_UPDATE:case b("FBRTCConstants").PayloadType.ANSWER_ACK:case b("FBRTCConstants").PayloadType.SET_VIDEO:case b("FBRTCConstants").PayloadType.OFFER_NACK:case b("FBRTCConstants").PayloadType.VIDEO_REQUEST:case b("FBRTCConstants").PayloadType.ACK:break;default:break}};c.$13=function(a){__p&&__p();var c=this,d=a.callID,e=a.msg,f=a.peerID;if(this.$16(d))return;if(e.calltype){this.$6.sendOfferNack(f,d,e);return}this.$12()?this.$6.sendOfferAck(f,d,e):this.$6.sendOfferNack(f,d,e);this.$8.logCallAction(f,d,b("FBRTCLogger").CallAction.RECEIVED_CALL);var g=this.$17(f,d,a);g.setUploadLogLevel(b("FBRTCLocalUploadLogLevel").getUploadLogLevel(b("FBRTCConstants").convertToUploadLogLevel(e.ull)));if(b("FBRTCCallBlockingStore").getBlockingStatus()){this.$18(f,d,g,b("FBRTCConstants").CallEndReason.IGNORE_CALL,!1,!1,!1,"calling disabled");return}var h=this.$1.getCallEndReasonForNewRequest();if(this.$4&&!this.$4.isForPeer(f)||h===b("FBRTCConstants").CallEndReason.IN_ANOTHER_CALL){this.$18(f,d,g,b("FBRTCConstants").CallEndReason.IN_ANOTHER_CALL,!1,!1,!0);this.$3.onCallMissed(f);return}if(!b("FBRTCSupport").isWebrtcSupported()){this.$18(f,d,g,b("FBRTCConstants").CallEndReason.UNSUPPORTED_VERSION,!1,!1,!1);this.$2.showForIncomingCall(d,f);return}h=new this.$1(f,d);this.$5=g;h.addListener("answerCall",function(b,e){c.$19(f,d,a,g,e)});h.addListener("ignoreCall",function(){c.$20(f,d,g)});h.addListener("timeout",function(){c.$21(f,d,g)});this.$3.hideDialog();e=e.videoon?b("FBRTCConstants").IncomingCallDialogTypes.VIDEO:b("FBRTCConstants").IncomingCallDialogTypes.AUDIO;h.showIncomingDialog(e);this.$4=h;this.$8.logEvent(f,d,"Incoming call dialog shown");this.$22(f)};c.$22=function(a){document.hasFocus()||this.$23(a)};c.$24=function(){this.$25()};c.$23=function(a){var c=this;a=b("MercuryIDs").getParticipantIDFromUserID(a);b("MessengerParticipants.bs").get(a,function(a){if(!c.$4)return;c.$9=b("DocumentTitle").blink(g._("{name} appelle",[g._param("name",a.short_name)]))});b("UserActivity").subscribeOnce(this.$25.bind(this))};c.$25=function(){this.$9&&(this.$9.stop(),this.$9=null)};c.$26=function(){this.$4&&this.$4.cancel(),this.$4=null,this.$5=null,this.$24()};c.$14=function(a){__p&&__p();var c=a.peerID,d=a.callID;a=a.msg;this.$27(d);if(this.$4&&this.$4.isForPeerAndCall(c,d)){a=a.reason;(typeof a==="string"||a instanceof String)&&(a=b("FBRTCConstants").endCallReasonFromString(a));this.$18(c,d,this.$5,a,!0,!0,!1);this.$26();a!==b("FBRTCConstants").CallEndReason.OTHER_INSTANCE_HANDLED&&(this.$3.onCallMissed(c),this.$3.showDialog())}};c.$12=function(){return b("FBRTCSupport").isWebrtcSupported()};c.$15=function(a){a=a.callID;this.$27(a);b("FBRTCSupport").isWebrtcSupported()||this.$2.dismiss();this.$4&&this.$4.isForCall(a)&&this.$26()};c.$27=function(a){this.$10.set(a,!0,null,h)};c.$16=function(a){return this.$10.has(a)};c.$17=function(a,c,d){a=new(b("FBRTCCallSummary"))({peerID:a,callID:c,isCaller:!1});a.setCallTrigger("incoming_p2p_ring_dialog");a.setActiveConnection("p2p");a.onFullMessageReceived(d);a.onOfferAckSent(d.msg);return a};c.$19=function(a,c,d,e,f){var g=!d.msg.videoon;e.onPressedAnswer();e.save(this.$7);this.$8.logCallAction(a,c,b("FBRTCLogger").CallAction.ANSWER_CALL);this.$6.sendOtherDismiss(c);!b("RTWebExperiments").passOfferWithWindowMessages()?b("FBRTCLocalMessageQueue").writePeerOfferToStorage(a,d.originalMessageData):b("RTWebExperiments").enableCallCollisionFix()||b("FBRTCLocalMessageQueue").enqueueMessage(a,d.msgID,d.originalMessageData);d=this.$11;d?d({peerID:a,callID:String(c),callSummary:e,initializeVideo:f,isAudioCall:g}):b("FBRTCCallUIWrapper").openAsCallee(a,c,e,g,f);this.$26()};c.$20=function(a,c,d){this.$18(a,c,d,b("FBRTCConstants").CallEndReason.IGNORE_CALL,!1,!0,!0),this.$26()};c.$21=function(a,c,d){this.$18(a,c,d,b("FBRTCConstants").CallEndReason.NO_ANSWER_TIMEOUT,!1,!1,!1),this.$26(),this.$3.onCallMissed(a),this.$3.showDialog()};c.$18=function(a,c,d,e,f,g,h,i){i===void 0&&(i=null);h&&this.$6.sendHangup(a,c,e);g&&this.$6.sendOtherDismiss(c);d&&(d.onCallEnded(e,f,null,i),d.save(this.$7));h=b("FBRTCConstants").fullCallEndReasonString(e,f);this.$8.logCallAction(a,c,b("FBRTCLogger").CallAction.END_CALL,h)};return a}();e.exports=a}),null);
__d("XIncomingCallDialogController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/incoming/",{user_id:{type:"FBID",required:!0},call_id:{type:"Int"},dialog_type:{type:"String",defaultValue:"VIDEO"},__asyncDialog:{type:"Int"}})}),null);
__d("FBRTCIncomingCallDialog",["AsyncDialog","AsyncRequest","Dialog","EventEmitter","FBRTCConstants","FBRTCSoundController","XIncomingCallDialogController","clearTimeout","setTimeout","setTimeoutAcrossTransitions"],(function(a,b,c,d,e,f){__p&&__p();var g=7e4;a=function(a){"use strict";__p&&__p();babelHelpers.inheritsLoose(c,a);function c(b,c){var d;d=a.call(this)||this;d.peerID=b;d.callID=c;d.$FBRTCIncomingCallDialog2=!1;d.$FBRTCIncomingCallDialog1=null;return d}c.getCallEndReasonForNewRequest=function(){return null};var d=c.prototype;d.showIncomingDialog=function(a){var c=b("Dialog").getCurrent();c&&c.hide();c=b("XIncomingCallDialogController").getURIBuilder().setFBID("user_id",this.peerID).setInt("call_id",this.callID).setString("dialog_type",a).getURI();this.$FBRTCIncomingCallDialog1=new(b("AsyncRequest"))(c);this.$FBRTCIncomingCallDialog2=a===b("FBRTCConstants").IncomingCallDialogTypes.VIDEO;b("AsyncDialog").send(this.$FBRTCIncomingCallDialog1,this.$FBRTCIncomingCallDialog3.bind(this))};d.$FBRTCIncomingCallDialog3=function(a){__p&&__p();if(!this.$FBRTCIncomingCallDialog1){b("setTimeout")(function(){a.hide()},1);return}this.$FBRTCIncomingCallDialog1=null;this.view=a;a.subscribe("confirm",this.$FBRTCIncomingCallDialog4.bind(this));a.subscribe("cancel",this.$FBRTCIncomingCallDialog5.bind(this));b("FBRTCSoundController").playIncomingRingtone(this.callID,this.peerID,{loop:!0,isP2P:!0});this.timeout=b("setTimeoutAcrossTransitions")(this.$FBRTCIncomingCallDialog6.bind(this),g)};d.cancel=function(){this.$FBRTCIncomingCallDialog1&&(this.$FBRTCIncomingCallDialog1.abort(),this.$FBRTCIncomingCallDialog1=null),this.timeout&&b("clearTimeout")(this.timeout),this.view&&(this.view.hide(),this.view=null),b("FBRTCSoundController").stopIncomingRingtone()};d.isForPeer=function(a){return this.peerID===a};d.isForCall=function(a){return this.callID===a};d.isForPeerAndCall=function(a,b){return this.peerID===a&&this.callID===b};d.$FBRTCIncomingCallDialog4=function(){this.cancel(),this.emit("answerCall",this.callID,this.$FBRTCIncomingCallDialog2)};d.$FBRTCIncomingCallDialog5=function(){this.cancel(),this.emit("ignoreCall",!1)};d.$FBRTCIncomingCallDialog6=function(){this.cancel(),this.emit("timeout",!1)};return c}(b("EventEmitter"));e.exports=a}),null);
__d("XVideoCallMissedCallController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/missed_call/",{user_id:{type:"Int",required:!0},__asyncDialog:{type:"Int"}})}),null);
__d("XVideoCallMissedCallDialogController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/dismiss_all_missed_call_dialog/",{})}),null);
__d("FBRTCMissedVideoCallHandler",["Arbiter","AsyncDialog","AsyncRequest","ChannelConstants","FBRTCCore","FBRTCLogger","FBRTCSupport","XVideoCallMissedCallController","XVideoCallMissedCallDialogController"],(function(a,b,c,d,e,f){__p&&__p();var g=null,h=null,i=null;a=function(){"use strict";__p&&__p();function a(){this.$1=null}var c=a.prototype;c.hideDialog=function(){g&&(g.hide(),g=null,h=null,i&&(i.unsubscribe(),i=null))};c.onCallMissed=function(a){if(!b("FBRTCSupport").isWebrtcSupported())return;h===null&&(this.$1=a)};c.showDialog=function(){if(!this.$1||h)return;h=this.$1;this.$1=null;var a=b("XVideoCallMissedCallController").getURIBuilder().setInt("user_id",h).getURI();a=new(b("AsyncRequest"))(a);b("AsyncDialog").send(a,this.$2.bind(this))};c.$2=function(a){g=a,a.subscribe("confirm",this.$3.bind(this)),a.subscribe("cancel",this.$4.bind(this)),i=b("Arbiter").subscribe(b("ChannelConstants").getArbiterType("dismiss_all_missed_call_dialog"),this.$5.bind(this))};c.$3=function(){h&&b("FBRTCCore").startOutgoingCall(h,b("FBRTCLogger").Trigger.RETURN_CALL,!1),this.$4()};c.$4=function(){this.hideDialog(),this.$6()};c.$6=function(){new(b("AsyncRequest"))(b("XVideoCallMissedCallDialogController").getURIBuilder().getURI()).send()};c.$5=function(){this.hideDialog()};return a}();e.exports=a}),null);
__d("XBrowserNotSupportedDialogController",["XController"],(function(a,b,c,d,e,f){e.exports=b("XController").create("/videocall/browser_not_supported/",{is_group_call:{type:"Bool",defaultValue:!1},participants:{type:"StringVector"},user_id:{type:"Int"},warning:{type:"Bool",defaultValue:!1},call_type:{type:"Enum",defaultValue:2,enumType:0},__asyncDialog:{type:"Int"}})}),null);
__d("FBRTCUnsupportedBrowserMessage",["AsyncDialog","AsyncRequest","FBRTCCallConstants","FBRTCSoundController","XBrowserNotSupportedDialogController"],(function(a,b,c,d,e,f){__p&&__p();var g=b("FBRTCCallConstants").FBRTCCallType;a={_dialog:null,warnForOutgoingCall:function(a){var c=b("XBrowserNotSupportedDialogController").getURIBuilder().setBool("warning",!0).getURI();this._presentDialog(c,a)},showForOutgoingCall:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().getURI();this._presentDialog(a)},showForIncomingCall:function(a,c){b("FBRTCSoundController").playIncomingRingtone(a,c,{loop:!1,isP2P:!0,isUnsupportedDialog:!0});a=b("XBrowserNotSupportedDialogController").getURIBuilder().setInt("user_id",c).getURI();this._presentDialog(a)},showForIncomingGroupCall:function(a,c,d,e){b("FBRTCSoundController").playIncomingRingtone(a,e,{loop:!1,isP2P:!1,isUnsupportedDialog:!0});a=b("XBrowserNotSupportedDialogController").getURIBuilder().setBool("is_group_call",!0).setInt("user_id",d).setStringVector("participants",c).getURI();this._presentDialog(a)},showForOutgoingGroupCall:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().setBool("is_group_call",!0).getURI();this._presentDialog(a)},showForUnsupportedCollabCall:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().setEnum("call_type",g.COLLAB_VIDEO_CALL).getURI();this._presentDialog(a)},showForUnsupportedCollabScreenSharing:function(){var a=b("XBrowserNotSupportedDialogController").getURIBuilder().setEnum("call_type",g.COLLAB_SCREEN_SHARE_CALL).getURI();this._presentDialog(a)},dismiss:function(){this._dialog&&this._dialog.hide()},_presentDialog:function(a,c){var d=this;if(this._dialog)return;a=new(b("AsyncRequest"))(a);b("AsyncDialog").send(a,function(a){d._dialog=a,a.subscribe("hide",function(){d._dialog=null,c&&c()})})}};e.exports=a}),null);